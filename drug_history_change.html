<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra c·ª©u L·ªãch s·ª≠ Thu·ªëc (Supabase Live)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #1a73e8; --bg: #f0f2f5; --text: #333; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        
        /* LAYOUT CH√çNH */
        .container { 
            max-width: 1600px; margin: 0 auto; background: white; 
            border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            display: flex; flex-direction: column; height: 90vh; 
        }

        /* HEADER */
        .header { padding: 15px 20px; border-bottom: 1px solid #eee; flex-shrink: 0; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header h1 { margin: 0; color: var(--primary); font-size: 20px; display: flex; align-items: center; gap: 10px; }
        
        /* CONTROLS & SEARCH */
        .controls { display: flex; gap: 10px; align-items: center; }
        .search-box { position: relative; width: 400px; }
        .search-box input { 
            width: 100%; padding: 10px 35px 10px 10px; 
            border: 1px solid #ddd; border-radius: 4px; outline: none; font-size: 14px; transition: border 0.3s;
        }
        .search-box input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(26,115,232,0.1); }
        .search-box i { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #999; }
        
        /* TABLE */
        .table-wrapper { flex: 1; overflow: auto; scrollbar-width: thin; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        
        th { 
            background: #f8f9fa; padding: 12px 15px; text-align: left; 
            font-size: 13px; font-weight: 600; color: #555; 
            position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #eee; 
        }
        td { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; font-size: 14px; vertical-align: middle; }
        
        /* PARENT ROW (D√≤ng thu·ªëc) */
        tr.parent-row { transition: background 0.2s; cursor: pointer; }
        tr.parent-row:hover { background-color: #f1f3f4; }
        tr.parent-row.expanded { background-color: #e8f0fe; border-left: 4px solid var(--primary); }
        
        .toggle-icon { transition: transform 0.2s; color: #aaa; width: 20px; text-align: center; }
        tr.parent-row.expanded .toggle-icon { transform: rotate(90deg); color: var(--primary); }
        
        /* CHILD ROW (B·∫£ng chi ti·∫øt) */
        tr.child-row { display: none; }
        tr.child-row.show { display: table-row; }
        .detail-wrapper { background: #fafafa; padding: 15px 20px; border-bottom: 1px solid #eee; }
        
        .history-table { width: 100%; background: white; border: 1px solid #e0e0e0; font-size: 13px; border-radius: 4px; overflow: hidden; }
        .history-table th { background: #5f6368; color: white; border: none; padding: 8px 12px; }
        .history-table td { border-bottom: 1px solid #eee; padding: 8px 12px; vertical-align: top; }
        
        .col-old { background-color: #fff5f5; color: #c53030; }
        .col-new { background-color: #f0fff4; color: #22543d; }

        /* BADGES */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; display: inline-block; }
        .badge-info { background: #e8f0fe; color: #1967d2; border-radius: 12px; }
        .badge-id { font-family: monospace; background: #eee; color: #555; }
        
        /* FOOTER */
        .footer { padding: 10px 20px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; font-size: 13px; color: #666; }
        .btn-page { padding: 6px 16px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
        .btn-page:hover:not(:disabled) { background: #f1f1f1; border-color: #ccc; }
        .btn-page:disabled { opacity: 0.5; cursor: default; }
        
        /* LOADING */
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: #666; font-weight: 500;">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Supabase...</p>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-top">
                <h1><i class="fas fa-capsules"></i> Tra c·ª©u L·ªãch s·ª≠ Thu·ªëc</h1>
                <span class="badge badge-info" id="statusInfo" style="padding: 6px 12px; font-size: 13px;">ƒêang k·∫øt n·ªëi...</span>
            </div>
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="search" placeholder="üîç T√¨m t√™n thu·ªëc, SƒêK ho·∫∑c ID (G√µ v√† ƒë·ª£i 1s)..." autocomplete="off">
                    <i class="fas fa-search" id="searchIcon"></i>
                </div>
                <div style="font-size: 13px; color: #888; font-style: italic;">
                    * S·∫Øp x·∫øp ∆∞u ti√™n: Ng√†y bi·∫øn ƒë·ªông m·ªõi nh·∫•t
                </div>
            </div>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th style="width: 40px"></th>
                        <th style="width: 100px">ID</th>
                        <th>T√™n thu·ªëc</th>
                        <th style="width: 180px">S·ªë ƒêƒÉng K√Ω</th>
                        <th style="width: 140px">T·ªïng thay ƒë·ªïi</th>
                        <th style="width: 140px">Bi·∫øn ƒë·ªông cu·ªëi</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>

        <div class="footer">
            <div id="pageInfo">Trang 1</div>
            <div>
                <button class="btn-page" id="prevBtn" onclick="app.changePage(-1)">Tr∆∞·ªõc</button>
                <button class="btn-page" id="nextBtn" onclick="app.changePage(1)">Sau</button>
            </div>
        </div>
    </div>

    <script>
        // --- C·∫§U H√åNH K·∫æT N·ªêI SUPABASE ---
        const SB_URL = 'https://fdvlpnfxbcpfsuapujfs.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkdmxwbmZ4YmNwZnN1YXB1amZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNzc3MDcsImV4cCI6MjA4NDk1MzcwN30.rbfEdaPUdhsoSR5UFeRF5RjmK6D86PurciROW_zNPFY';
        
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        const app = {
            data: [], 
            pageSize: 100, // S·ªë thu·ªëc hi·ªÉn th·ªã m·ªói trang
            currentPage: 1, 
            currentSearch: '',

            init: function() {
                this.fetchData();

                // --- QUAN TR·ªåNG: DELAY 1 GI√ÇY (1000ms) KHI G√ï T√åM KI·∫æM ---
                document.getElementById('search').addEventListener('input', this.debounce((e) => {
                    this.currentSearch = e.target.value.trim();
                    this.currentPage = 1;
                    this.fetchData();
                }, 1000));
            },

            fetchData: async function() {
                const loading = document.getElementById('loading');
                loading.style.display = 'flex';
                
                try {
                    const from = (this.currentPage - 1) * this.pageSize;
                    const to = from + this.pageSize - 1;

                    // 1. Kh·ªüi t·∫°o Query
                    let query = _supabase
                        .from('history_drug_change')
                        .select('*', { count: 'exact' });

                    // 2. X·ª≠ l√Ω T√¨m ki·∫øm
                    if (this.currentSearch) {
                        query = query.or(`ten_thuoc.ilike.%${this.currentSearch}%,so_dang_ky.ilike.%${this.currentSearch}%,drug_id.ilike.%${this.currentSearch}%`);
                    }

                    // 3. X·ª≠ l√Ω S·∫Øp x·∫øp (QUAN TR·ªåNG)
                    // ∆Øu ti√™n 1: Ng√†y sort_date (Thu·ªëc c√≥ s·ª± ki·ªán m·ªõi nh·∫•t l√™n ƒë·∫ßu)
                    // ∆Øu ti√™n 2: drug_id (ƒê·ªÉ c√°c d√≤ng c·ªßa c√πng 1 thu·ªëc n·∫±m c·∫°nh nhau cho vi·ªác gom nh√≥m)
                    const { data, error, count } = await query
                        .order('sort_date', { ascending: false }) 
                        .order('drug_id', { ascending: false })   
                        .range(from, to);

                    if (error) throw error;

                    // 4. Gom nh√≥m d·ªØ li·ªáu (Ph·∫≥ng -> L·ªìng nhau)
                    const groupedData = this.groupDataByID(data);
                    
                    // 5. Render
                    this.render(groupedData);
                    
                    // 6. C·∫≠p nh·∫≠t Footer
                    document.getElementById('statusInfo').innerText = `T·ªïng: ${count} d√≤ng l·ªãch s·ª≠`;
                    document.getElementById('pageInfo').innerText = `Trang ${this.currentPage} (Hi·ªÉn th·ªã ${groupedData.length} thu·ªëc)`;
                    document.getElementById('prevBtn').disabled = this.currentPage === 1;
                    document.getElementById('nextBtn').disabled = (to >= count);

                } catch (e) {
                    console.error(e);
                    alert('L·ªói t·∫£i d·ªØ li·ªáu: ' + e.message);
                } finally {
                    loading.style.display = 'none';
                }
            },

            // H√†m bi·∫øn ƒë·ªïi d·ªØ li·ªáu ph·∫≥ng th√†nh d·ªØ li·ªáu gom nh√≥m theo ID
            groupDataByID: function(flatData) {
                const groups = {};
                flatData.forEach(item => {
                    // D√πng drug_id l√†m kh√≥a ch√≠nh
                    const key = item.drug_id || 'UNKNOWN';
                    
                    if (!groups[key]) {
                        groups[key] = {
                            drug_id: item.drug_id,
                            ten_thuoc: item.ten_thuoc,
                            so_dang_ky: item.so_dang_ky,
                            sort_date: item.sort_date, // D√πng ng√†y n√†y ƒë·ªÉ hi·ªÉn th·ªã c·ªôt "Bi·∫øn ƒë·ªông cu·ªëi"
                            history: []
                        };
                    }
                    groups[key].history.push(item);
                });
                return Object.values(groups);
            },

            render: function(listData) {
                const tbody = document.getElementById('tbody');
                if (listData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 40px; color:#999; font-style:italic">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ph√π h·ª£p</td></tr>';
                    return;
                }

                const html = listData.map((item, index) => {
                    const rowId = `row-${index}`;
                    return `
                    <tr class="parent-row" onclick="app.toggleDetail('${rowId}')">
                        <td><div class="toggle-icon" id="icon-${rowId}"><i class="fas fa-chevron-right"></i></div></td>
                        <td><span class="badge badge-id">${item.drug_id || '-'}</span></td>
                        <td style="font-weight: 500; color: var(--primary);">${item.ten_thuoc || '(Ch∆∞a c·∫≠p nh·∫≠t t√™n)'}</td>
                        <td><b>${item.so_dang_ky || '-'}</b></td>
                        <td><span class="badge badge-info">${item.history.length} s·ª± ki·ªán</span></td>
                        <td style="color:#666; font-size:12px;">${this.formatDate(item.sort_date)}</td>
                    </tr>
                    
                    <tr class="child-row" id="child-${rowId}">
                        <td colspan="6" style="padding: 0;">
                            <div class="detail-wrapper">
                                <table class="history-table">
                                    <thead>
                                        <tr>
                                            <th style="width:110px">Ng√†y s·ª≠a</th>
                                            <th style="width:20%">N·ªôi dung</th>
                                            <th class="col-old">Th√¥ng tin c≈©</th>
                                            <th class="col-new">Th√¥ng tin m·ªõi</th>
                                            <th style="width:15%">L√Ω do</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${item.history.map(h => `
                                            <tr>
                                                <td style="font-weight:600">${this.formatDateSimple(h.ngay_sua_doi)}</td>
                                                <td>
                                                    <b>${h.noi_dung_thay_doi}</b>
                                                    ${h.chi_tiet ? `<br><small style="color:#666">${h.chi_tiet}</small>` : ''}
                                                </td>
                                                <td class="col-old">${h.thong_tin_cu || '-'}</td>
                                                <td class="col-new">${h.thong_tin_moi || '-'}</td>
                                                <td>${h.ly_do || ''}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </td>
                    </tr>`;
                }).join('');
                tbody.innerHTML = html;
            },

            toggleDetail: function(id) {
                const row = document.getElementById(`child-${id}`);
                const icon = document.getElementById(`icon-${id}`).parentElement.parentElement;
                
                if (row.classList.contains('show')) {
                    row.classList.remove('show');
                    icon.classList.remove('expanded');
                } else {
                    row.classList.add('show');
                    icon.classList.add('expanded');
                }
            },

            changePage: function(step) {
                this.currentPage += step;
                this.fetchData();
            },

            // H√†m Debounce: Ch·ªù 1 kho·∫£ng th·ªùi gian m·ªõi th·ª±c thi
            debounce: function(func, wait) { 
                let timeout; 
                return function(...args) { 
                    clearTimeout(timeout); 
                    timeout = setTimeout(() => func.apply(this, args), wait); 
                }; 
            },
            
            formatDate: function(iso) {
                if(!iso) return '-';
                try { return new Date(iso).toLocaleDateString('vi-VN'); } catch { return iso; }
            },
            
            formatDateSimple: function(str) {
                if(!str) return '-';
                return str.replace('T00:00:00', '');
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
