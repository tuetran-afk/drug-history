<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra cứu Lịch sử Thuốc (Supabase Original)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- CSS GỐC TỪ FILE PYTHON CỦA ÔNG --- */
        :root { --primary: #1a73e8; --bg: #f0f2f5; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1700px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; height: 90vh; }
        .header { padding: 15px 20px; border-bottom: 1px solid #eee; background: #fff; flex-shrink: 0; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header h1 { margin: 0; color: var(--primary); font-size: 20px; }
        .controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .search-box { position: relative; width: 300px; }
        .search-box input { width: 100%; padding: 8px 30px 8px 10px; border: 1px solid #ddd; border-radius: 4px; outline: none; }
        .search-box i { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #999; }
        .btn-filter { padding: 6px 12px; border: 1px solid #e0e0e0; background: white; border-radius: 4px; cursor: pointer; font-size: 13px; color: #555; }
        .btn-filter.active { background: var(--primary); color: white; border-color: var(--primary); }
        .table-wrapper { flex: 1; overflow: auto; position: relative; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { background: #f8f9fa; padding: 10px 15px; text-align: left; font-weight: 600; font-size: 13px; color: #555; position: sticky; top: 0; z-index: 10; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        td { padding: 10px 15px; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        tr.parent-row:hover { background-color: #f8faff; cursor: pointer; }
        tr.parent-row.expanded { background-color: #e8f0fe; border-left: 3px solid var(--primary); }
        .toggle-icon { transition: transform 0.2s; color: #ccc; width: 20px; text-align: center; }
        tr.parent-row.expanded .toggle-icon { transform: rotate(90deg); color: var(--primary); }
        .badge { padding: 3px 6px; border-radius: 4px; font-size: 11px; font-weight: 600; display: inline-block; }
        .badge-new { background: #e6f4ea; color: #1e8e3e; }
        .badge-info { background: #e8f0fe; color: #1967d2; }
        .badge-gray { background: #f1f3f4; color: #5f6368; }
        tr.child-row { display: none; background: #fafafa; }
        tr.child-row.show { display: table-row; }
        .detail-container { padding: 15px; border-bottom: 2px solid #eee; }
        .detail-table { width: 100%; border: 1px solid #ddd; background: white; font-size: 13px; }
        .detail-table th { background: #6c757d; color: white; padding: 8px; font-size: 12px; }
        .detail-table td { padding: 8px; border: 1px solid #eee; vertical-align: top; }
        .col-old { background: #fff5f5; color: #c53030; width: 20%; }
        .col-new { background: #f0fff4; color: #22543d; width: 20%; }
        .footer { padding: 10px 20px; border-top: 1px solid #eee; background: #fff; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .pagination { display: flex; gap: 5px; align-items: center; }
        .page-btn { padding: 5px 10px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; min-width: 32px; }
        .page-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .page-btn:disabled { opacity: 0.5; cursor: default; }
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .date-mod { color: #1a73e8; font-weight: 600; }
        .date-scan { color: #666; font-size: 12px; }
    </style>
</head>
<body>
    <div id="loading"><div class="spinner"></div><p style="margin-top:15px; color:#666">Đang tải dữ liệu Supabase...</p></div>

    <div class="container">
        <div class="header">
            <div class="header-top">
                <h1><i class="fas fa-history"></i> Lịch sử Thay đổi Thuốc</h1>
                <div><span class="badge badge-info" id="totalCount">0 bản ghi</span></div>
            </div>
            <div class="controls">
                <div class="search-box"><input type="text" id="search" placeholder="Tìm tên thuốc, SĐK..." autocomplete="off"><i class="fas fa-search"></i></div>
                <button class="btn-filter active" onclick="app.setFilter('all')">Tất cả</button>
                <button class="btn-filter" onclick="app.setFilter('changed')">Có thay đổi</button>
            </div>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th style="width: 40px"></th>
                        <th>Tên thuốc</th>
                        <th style="width: 150px">Số Đăng Ký</th>
                        <th style="width: 100px">Trạng thái</th>
                        <th style="width: 140px">Ngày sửa đổi <i class="fas fa-sort-amount-down"></i></th>
                        <th style="width: 140px">Ngày quét</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>

        <div class="footer"><div style="font-size: 13px; color: #666;" id="pageInfo"></div><div class="pagination" id="pagination"></div></div>
    </div>

    <script>
        // --- CẤU HÌNH SUPABASE ---
        // Ông thay 2 dòng này nhé
        const SUPABASE_URL = 'https://fdvlpnfxbcpfsuapujfs.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkdmxwbmZ4YmNwZnN1YXB1amZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNzc3MDcsImV4cCI6MjA4NDk1MzcwN30.rbfEdaPUdhsoSR5UFeRF5RjmK6D86PurciROW_zNPFY';
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const app = {
            data: [], filteredData: [], pageSize: 50, currentPage: 1, filterType: 'all', searchTerm: '',
            
            init: async function() {
                try {
                    // 1. Fetch dữ liệu từ Supabase
                    let { data: rawData, error } = await supabase
                        .from('history_drug_change')
                        .select('*')
                        .order('ngay_sua_doi', { ascending: false });

                    if (error) throw error;

                    // 2. Gom nhóm dữ liệu (Vì Supabase trả về từng dòng lẻ, còn giao diện Python là gom theo thuốc)
                    this.data = this.groupDataBySDK(rawData);
                    
                    document.getElementById('loading').style.display = 'none';
                    
                    // 3. Render ban đầu
                    this.applyFilter();

                    // 4. Sự kiện tìm kiếm
                    document.getElementById('search').addEventListener('input', this.debounce((e) => {
                        this.searchTerm = e.target.value.toLowerCase(); this.currentPage = 1; this.applyFilter();
                    }, 300));

                } catch (e) {
                    alert('Lỗi: ' + e.message);
                }
            },

            // Hàm gom nhóm dữ liệu để tạo Master-Detail giống Python
            groupDataBySDK: function(flatData) {
                const groups = {};
                flatData.forEach((item, index) => {
                    const key = item.so_dang_ky || 'NO_SDK_' + index;
                    
                    if (!groups[key]) {
                        groups[key] = {
                            id: index, // ID ảo để làm toggle
                            ten_thuoc: item.ten_thuoc,
                            so_dang_ky: item.so_dang_ky,
                            chi_tiet: [],
                            last_updated: item.ngay_sua_doi,
                            last_scan: item.created_at || item.ngay_sua_doi // Giả lập ngày quét
                        };
                    }
                    // Thêm vào danh sách chi tiết
                    groups[key].chi_tiet.push({
                        ngay_sua_doi: item.ngay_sua_doi,
                        noi_dung_thay_doi: item.noi_dung_thay_doi,
                        // Nếu cột database của ông không có 'thong_tin_cu', code sẽ để trống
                        thong_tin_cu: item.thong_tin_cu || '', 
                        thong_tin_moi: item.thong_tin_moi || '',
                        ly_do: item.ly_do || '',
                        chi_tiet: item.chi_tiet || '' // Trường hợp có cột chi tiết riêng
                    });

                    // Cập nhật ngày mới nhất của thuốc đó
                    if (item.ngay_sua_doi > groups[key].last_updated) {
                        groups[key].last_updated = item.ngay_sua_doi;
                    }
                });
                return Object.values(groups);
            },

            debounce: function(func, wait) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); }; },
            
            setFilter: function(type) { 
                this.filterType = type; 
                this.currentPage = 1; 
                document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active')); 
                event.target.classList.add('active'); 
                this.applyFilter(); 
            },

            applyFilter: function() {
                this.filteredData = this.data.filter(item => {
                    if (this.filterType === 'changed' && item.chi_tiet.length === 0) return false;
                    
                    if (this.searchTerm) {
                        const s = this.searchTerm;
                        return (item.ten_thuoc && item.ten_thuoc.toLowerCase().includes(s)) || (item.so_dang_ky && item.so_dang_ky.toLowerCase().includes(s));
                    }
                    return true;
                });
                document.getElementById('totalCount').innerText = `${this.filteredData.length} bản ghi`;
                this.renderPage(); this.renderPagination();
            },

            renderPage: function() {
                const start = (this.currentPage - 1) * this.pageSize;
                const end = start + this.pageSize;
                const pageData = this.filteredData.slice(start, end);
                const tbody = document.getElementById('tbody');
                
                if (pageData.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:30px; color:#999">Không tìm thấy dữ liệu</td></tr>'; return; }
                
                let html = '';
                pageData.forEach(item => {
                    const countChange = item.chi_tiet.length;
                    const statusBadge = countChange > 0 ? `<span class="badge badge-new">${countChange} thay đổi</span>` : `<span class="badge badge-gray">Không đổi</span>`;
                    
                    // Render dòng cha (Master)
                    html += `
                    <tr class="parent-row" onclick="app.toggleDetail(${item.id})">
                        <td><div class="toggle-icon" id="icon-${item.id}"><i class="fas fa-chevron-right"></i></div></td>
                        <td style="font-weight:500">${item.ten_thuoc || ''}</td>
                        <td>${item.so_dang_ky || ''}</td>
                        <td>${statusBadge}</td>
                        <td class="date-mod">${this.formatDateVN(item.last_updated)}</td>
                        <td class="date-scan">${this.formatDateTimeVN(item.last_scan)}</td>
                    </tr>
                    <tr class="child-row" id="child-${item.id}">
                        <td colspan="7" style="padding:0"><div class="detail-container">${this.renderDetail(item.chi_tiet)}</div></td>
                    </tr>`;
                });
                tbody.innerHTML = html;
                document.querySelector('.table-wrapper').scrollTop = 0;
            },

            renderDetail: function(details) {
                if (!details || details.length === 0) return '<div style="color:#999; font-style:italic">Không có chi tiết.</div>';
                // Render bảng con (Detail Table) - Giống hệt style cũ
                let html = `<table class="detail-table"><thead><tr><th style="width:90px">Ngày duyệt</th><th style="width:20%">Nội dung</th><th class="col-old">Thông tin cũ</th><th class="col-new">Thông tin mới</th><th style="width:15%">Lý do</th></tr></thead><tbody>`;
                details.forEach(d => { 
                    html += `<tr>
                        <td>${this.formatDateVN(d.ngay_sua_doi) || '-'}</td>
                        <td><b>${d.noi_dung_thay_doi || ''}</b></td>
                        <td class="col-old">${d.thong_tin_cu || '-'}</td>
                        <td class="col-new">${d.thong_tin_moi || '-'}</td>
                        <td>${d.ly_do || '-'}</td>
                    </tr>`; 
                });
                return html + '</tbody></table>';
            },

            renderPagination: function() {
                const totalPages = Math.ceil(this.filteredData.length / this.pageSize);
                const pContainer = document.getElementById('pagination');
                const info = document.getElementById('pageInfo');
                if (totalPages <= 1) { pContainer.innerHTML = ''; info.innerText = ''; return; }
                info.innerText = `Trang ${this.currentPage} / ${totalPages}`;
                
                let html = '';
                if(this.currentPage > 1) html += `<button class="page-btn" onclick="app.changePage(${this.currentPage-1})"><i class="fas fa-angle-left"></i></button>`;
                html += `<button class="page-btn active">${this.currentPage}</button>`;
                if(this.currentPage < totalPages) html += `<button class="page-btn" onclick="app.changePage(${this.currentPage+1})"><i class="fas fa-angle-right"></i></button>`;
                
                pContainer.innerHTML = html;
            },

            changePage: function(page) { this.currentPage = page; this.renderPage(); this.renderPagination(); },
            
            toggleDetail: function(id) {
                const row = document.getElementById(`child-${id}`); 
                const icon = document.getElementById(`icon-${id}`).parentElement.parentElement; // Lấy tr parent
                
                if (row.classList.contains('show')) { 
                    row.classList.remove('show'); 
                    icon.classList.remove('expanded'); 
                } else { 
                    row.classList.add('show'); 
                    icon.classList.add('expanded'); 
                }
            },

            formatDateVN: function(isoDate) {
                if (!isoDate) return '';
                // Nếu data là text dạng dd/mm/yyyy thì trả về luôn
                if(isoDate.includes('/')) return isoDate; 
                try {
                    const d = new Date(isoDate);
                    return `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getFullYear()}`;
                } catch(e) { return isoDate; }
            },
            
            formatDateTimeVN: function(iso) { 
                if (!iso) return '';
                try {
                    const d = new Date(iso); 
                    return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`; 
                } catch(e) { return ''; }
            }
        };

        window.onload = function() { app.init(); };
    </script>
</body>
</html>
