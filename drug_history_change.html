<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra cứu Lịch sử Thuốc (Supabase Live)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #1a73e8; --bg: #f0f2f5; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1700px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; height: 90vh; }
        .header { padding: 15px 20px; border-bottom: 1px solid #eee; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header h1 { margin: 0; color: var(--primary); font-size: 20px; }
        .controls { display: flex; gap: 10px; align-items: center; }
        .search-box { position: relative; width: 400px; }
        .search-box input { width: 100%; padding: 8px 35px 8px 10px; border: 1px solid #ddd; border-radius: 4px; outline: none; }
        .search-box i { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #999; }
        .btn-filter { padding: 6px 12px; border: 1px solid #e0e0e0; background: white; border-radius: 4px; cursor: pointer; }
        .btn-filter.active { background: var(--primary); color: white; border-color: var(--primary); }
        .table-wrapper { flex: 1; overflow: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 12px; text-align: left; font-size: 13px; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        tr.parent-row:hover { background: #f8faff; cursor: pointer; }
        tr.parent-row.expanded { background: #e8f0fe; }
        .toggle-icon { transition: transform 0.2s; color: #ccc; }
        tr.parent-row.expanded .toggle-icon { transform: rotate(90deg); color: var(--primary); }
        .badge { padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .badge-info { background: #e8f0fe; color: #1967d2; }
        tr.child-row { display: none; background: #fafafa; }
        tr.child-row.show { display: table-row; }
        .detail-container { padding: 15px; margin: 10px; background: white; border: 1px solid #eee; border-radius: 4px; }
        .detail-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .detail-table th { background: #6c757d; color: white; position: static; }
        .detail-table td { border: 1px solid #eee; padding: 8px; }
        .col-old { background: #fff5f5; color: #c53030; }
        .col-new { background: #f0fff4; color: #22543d; }
        .footer { padding: 10px 20px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .page-btn { padding: 5px 15px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 99; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading"><div class="spinner"></div><p>Đang tải dữ liệu...</p></div>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <h1><i class="fas fa-history"></i> Lịch sử Thay đổi Thuốc</h1>
                <span class="badge badge-info" id="totalCount">0 kết quả</span>
            </div>
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="search" placeholder="Tìm tên thuốc hoặc SĐK...">
                    <i class="fas fa-search"></i>
                </div>
                <button class="btn-filter active" id="btnAll" onclick="app.setFilter('all')">Tất cả</button>
                <button class="btn-filter" id="btnChanged" onclick="app.setFilter('changed')">Có nội dung thay đổi</button>
            </div>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th style="width: 40px"></th>
                        <th>Tên thuốc</th>
                        <th style="width: 150px">Số Đăng Ký</th>
                        <th style="width: 120px">Trạng thái</th>
                        <th style="width: 140px">Ngày sửa đổi</th>
                        <th style="width: 140px">Ngày quét</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
        <div class="footer">
            <div id="pageInfo">Trang 1</div>
            <div class="pagination">
                <button class="page-btn" id="prevPage" onclick="app.changePage(-1)">Trước</button>
                <button class="page-btn" id="nextPage" onclick="app.changePage(1)">Sau</button>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = 'https://fdvlpnfxbcpfsuapujfs.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkdmxwbmZ4YmNwZnN1YXB1amZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNzc3MDcsImV4cCI6MjA4NDk1MzcwN30.rbfEdaPUdhsoSR5UFeRF5RjmK6D86PurciROW_zNPFY';
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        const app = {
            pageSize: 50, currentPage: 1, totalRecords: 0, currentSearch: '', filterType: 'all', data: [],
            init: function() {
                this.fetch();
                document.getElementById('search').addEventListener('input', this.debounce((e) => {
                    this.currentSearch = e.target.value.trim();
                    this.currentPage = 1;
                    this.fetch();
                }, 500));
            },
            fetch: async function() {
                document.getElementById('loading').style.display = 'flex';
                try {
                    const from = (this.currentPage - 1) * this.pageSize;
                    const to = from + this.pageSize - 1;
                    let query = _supabase.from('history_drug_change').select('*', { count: 'exact' });
                    
                    if (this.currentSearch) {
                        query = query.or(`ten_thuoc.ilike.%${this.currentSearch}%,so_dang_ky.ilike.%${this.currentSearch}%`);
                    }
                    if (this.filterType === 'changed') {
                        query = query.not('noi_dung_thay_doi', 'eq', '');
                    }

                    const { data, error, count } = await query.order('id', { ascending: false }).range(from, to);
                    if (error) throw error;

                    this.totalRecords = count || 0;
                    this.data = this.groupData(data);
                    this.render();
                } catch (e) { alert('Lỗi: ' + e.message); }
                finally { document.getElementById('loading').style.display = 'none'; }
            },
            groupData: function(flatData) {
                const groups = {};
                flatData.forEach(item => {
                    const key = `${item.so_dang_ky}_${item.ngay_sua_doi}`;
                    if (!groups[key]) {
                        groups[key] = {
                            display_id: item.id,
                            ten_thuoc: item.ten_thuoc,
                            so_dang_ky: item.so_dang_ky,
                            last_mod: item.ngay_sua_doi,
                            last_scan: item.last_updated,
                            chi_tiet: []
                        };
                    }
                    groups[key].chi_tiet.push(item);
                });
                return Object.values(groups);
            },
            render: function() {
                const tbody = document.getElementById('tbody');
                document.getElementById('totalCount').innerText = `${this.totalRecords} kết quả`;
                document.getElementById('pageInfo').innerText = `Trang ${this.currentPage} / ${Math.ceil(this.totalRecords/this.pageSize) || 1}`;
                document.getElementById('prevPage').disabled = this.currentPage === 1;
                document.getElementById('nextPage').disabled = this.currentPage >= Math.ceil(this.totalRecords/this.pageSize);

                tbody.innerHTML = this.data.map(item => `
                    <tr class="parent-row" onclick="app.toggle('${item.display_id}')">
                        <td><div class="toggle-icon" id="icon-${item.display_id}"><i class="fas fa-chevron-right"></i></div></td>
                        <td style="color:var(--primary); font-weight:500">${item.ten_thuoc || '-'}</td>
                        <td><b>${item.so_dang_ky || '-'}</b></td>
                        <td><span class="badge badge-info">${item.chi_tiet.length} nội dung</span></td>
                        <td>${item.last_mod || '-'}</td>
                        <td style="font-size:12px; color:#666">${item.last_scan ? new Date(item.last_scan).toLocaleDateString('vi-VN') : '-'}</td>
                    </tr>
                    <tr class="child-row" id="child-${item.display_id}">
                        <td colspan="6"><div class="detail-container">
                            <table class="detail-table">
                                <thead><tr><th>Nội dung</th><th class="col-old">Thông tin cũ</th><th class="col-new">Thông tin mới</th><th>Lý do</th></tr></thead>
                                <tbody>${item.chi_tiet.map(d => `
                                    <tr>
                                        <td><b>${d.noi_dung_thay_doi}</b><br><small>${d.chi_tiet || ''}</small></td>
                                        <td class="col-old">${d.thong_tin_cu || '-'}</td>
                                        <td class="col-new">${d.thong_tin_moi || '-'}</td>
                                        <td>${d.ly_do || '-'}</td>
                                    </tr>
                                `).join('')}</tbody>
                            </table>
                        </div></td>
                    </tr>
                `).join('');
            },
            toggle: function(id) {
                const row = document.getElementById(`child-${id}`);
                const icon = document.getElementById(`icon-${id}`);
                const isShow = row.classList.toggle('show');
                icon.parentElement.parentElement.classList.toggle('expanded', isShow);
            },
            changePage: function(step) { this.currentPage += step; this.fetch(); },
            setFilter: function(type) {
                this.filterType = type; this.currentPage = 1;
                document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');
                this.fetch();
            },
            debounce: function(f, w) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => f(...a), w); }; }
        };
        window.onload = () => app.init();
    </script>
</body>
</html>
