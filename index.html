<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tra cứu Lịch sử Thuốc</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #007bff; --bg: #f4f7f6; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; }
        .app-container { max-width: 800px; margin: 0 auto; background: white; min-height: 100vh; display: flex; flex-direction: column; }
        .header { position: sticky; top: 0; z-index: 100; background: white; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .search-input { width: 100%; padding: 12px 40px 12px 15px; border: 1px solid #ddd; border-radius: 25px; font-size: 16px; outline: none; background: #f8f9fa; box-sizing: border-box; }
        .search-icon { position: absolute; right: 25px; top: 22px; color: #999; }
        .stats { font-size: 12px; color: #666; margin-top: 5px; padding: 0 5px; }
        .drug-list { flex: 1; padding: 0; margin: 0; list-style: none; }
        .drug-item { border-bottom: 1px solid #eee; padding: 15px; cursor: pointer; }
        .drug-item:active { background: #e9ecef; }
        .d-header { display: flex; justify-content: space-between; font-weight: 600; margin-bottom: 5px; }
        .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #f1f3f4; color: #555; }
        .badge.changed { background: #e6f4ea; color: #1e8e3e; }
        .detail-box { display: none; margin-top: 10px; background: #f8f9fa; border-radius: 8px; padding: 10px; }
        .detail-box.show { display: block; }
        .change-card { background: white; padding: 10px; border-radius: 6px; border: 1px solid #eee; margin-bottom: 8px; }
        .c-date { font-size: 11px; color: var(--primary); font-weight: 600; }
        .c-title { font-size: 13px; font-weight: 600; margin: 4px 0; }
        .c-row { font-size: 12px; display: flex; gap: 5px; margin-bottom: 2px; }
        .c-old { text-decoration: line-through; color: #dc3545; background: #fff5f5; }
        .c-new { color: #28a745; background: #f0fff4; }
        #loadMore { text-align: center; padding: 15px; color: var(--primary); cursor: pointer; display: none; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loader" style="position:fixed; inset:0; background:white; z-index:999; display:flex; align-items:center; justify-content:center"><div class="spinner"></div></div>
    <div class="app-container">
        <div class="header">
            <input type="text" id="search" class="search-input" placeholder="Tìm tên thuốc, SĐK..." autocomplete="off">
            <i class="fas fa-search search-icon"></i>
            <div class="stats" id="stats">Đang tải dữ liệu...</div>
        </div>
        <ul class="drug-list" id="list"></ul>
        <div id="loadMore">Xem thêm...</div>
    </div>
    <script>
        const app = {
            index: [], cache: {}, display: [], page: 1, size: 20,
            init: async function() {
                try {
                    this.index = await (await fetch('search_index.json')).json();
                    document.getElementById('loader').style.display = 'none';
                    this.doSearch('');
                    document.getElementById('search').addEventListener('input', e => {
                        clearTimeout(this.tm); this.tm = setTimeout(() => this.doSearch(e.target.value), 300);
                    });
                    document.getElementById('loadMore').addEventListener('click', () => this.render());
                } catch { alert('Lỗi tải dữ liệu'); }
            },
            doSearch: function(k) {
                this.page = 1; document.getElementById('list').innerHTML = '';
                const term = k.toLowerCase().trim();
                this.display = term ? this.index.filter(i => (i.t && i.t.toLowerCase().includes(term)) || (i.s && i.s.toLowerCase().includes(term))) : this.index;
                document.getElementById('stats').innerText = `${this.display.length.toLocaleString()} kết quả`;
                this.render();
            },
            render: function() {
                const start = (this.page - 1) * this.size, end = start + this.size;
                const items = this.display.slice(start, end);
                if (!items.length && start === 0) { document.getElementById('list').innerHTML = '<div style="padding:20px; text-align:center">Không tìm thấy</div>'; return; }
                
                let html = '';
                items.forEach(i => {
                    const badge = i.c > 0 ? `<span class="badge changed">${i.c} thay đổi</span>` : `<span class="badge">Không đổi</span>`;
                    html += `<li class="drug-item" onclick="app.loadDetail(this, '${i.i}', ${i.f})">
                        <div class="d-header"><span>${i.t}</span>${badge}</div>
                        <div style="font-size:13px; color:#666"><i class="fas fa-barcode"></i> ${i.s} &nbsp;|&nbsp; <i class="far fa-clock"></i> ${i.u ? new Date(i.u).toLocaleDateString('vi-VN') : '-'}</div>
                        <div class="detail-box" id="d-${i.i}"></div>
                    </li>`;
                });
                document.getElementById('list').insertAdjacentHTML('beforeend', html);
                document.getElementById('loadMore').style.display = end < this.display.length ? 'block' : 'none';
                this.page++;
            },
            loadDetail: async function(el, id, fid) {
                const box = document.getElementById(`d-${id}`);
                if (box.classList.contains('show')) { box.classList.remove('show'); return; }
                box.classList.add('show');
                if (box.innerHTML) return;
                
                box.innerHTML = '<div style="text-align:center; padding:10px"><i class="fas fa-spinner fa-spin"></i> Đang tải...</div>';
                if (!this.cache[fid]) this.cache[fid] = await (await fetch(`data/part_${fid}.json`)).json();
                
                const data = this.cache[fid][id];
                let h = '';
                if(!data || !data.length) h = '<div style="font-style:italic; color:#999">Không có chi tiết</div>';
                else data.forEach(d => {
                    h += `<div class="change-card"><div class="c-date">${d.ngay_sua_doi}</div><div class="c-title">${d.noi_dung_thay_doi}</div>
                    ${d.thong_tin_cu ? `<div class="c-row"><span style="min-width:25px;color:#888">Cũ:</span><span class="c-old">${d.thong_tin_cu}</span></div>` : ''}
                    ${d.thong_tin_moi ? `<div class="c-row"><span style="min-width:25px;color:#888">Mới:</span><span class="c-new">${d.thong_tin_moi}</span></div>` : ''}
                    <div style="font-size:11px; color:#999; margin-top:4px">${d.ly_do}</div></div>`;
                });
                box.innerHTML = h;
            }
        };
        app.init();
    </script>
</body>
</html>